# Инструкция по деплою на Render.com

## Шаг 1: Добавить JWT_SECRET в Environment Variables

1. Зайдите на [Render.com Dashboard](https://dashboard.render.com/)
2. Выберите ваш сервис (oneshakedown)
3. Перейдите в раздел **Environment**
4. Нажмите **Add Environment Variable**
5. Добавьте:
   - **Key**: `JWT_SECRET`
   - **Value**: `KOTAKBAS3991-JWT-SECRET-KEY-2024`
6. Нажмите **Save Changes**

## Шаг 2: Деплой обновлений

### Автоматический деплой (рекомендуется):
1. Закоммитьте изменения:
   ```bash
   git add .
   git commit -m "Миграция на JWT токены для устойчивости к передеплою"
   git push origin main
   ```
2. Render автоматически начнет деплой

### Ручной деплой:
1. В панели Render нажмите **Manual Deploy**
2. Выберите ветку **main**
3. Нажмите **Deploy**

## Шаг 3: Проверка после деплоя

1. Дождитесь завершения деплоя (обычно 2-5 минут)
2. Проверьте логи на наличие ошибок
3. Откройте сайт: https://oneshakedown.onrender.com
4. Попробуйте войти через Google или Yandex
5. Закройте браузер и откройте снова - вы должны остаться авторизованными

## Что изменилось?

### До обновления:
- ❌ Пользователи выходили из аккаунта при каждом передеплое
- ❌ Сессии хранились в памяти сервера
- ❌ При перезапуске сервера все сессии терялись

### После обновления:
- ✅ Пользователи остаются авторизованными при передеплое
- ✅ JWT токены хранятся на клиенте (localStorage)
- ✅ Токены действительны 30 дней
- ✅ Сервер не хранит состояние сессий

## Важные замечания:

1. **Существующие пользователи** должны будут войти заново **один раз** после обновления
2. После входа они останутся авторизованными даже при передеплое
3. Токены автоматически обновляются при каждом входе
4. Токены безопасно подписаны с помощью JWT_SECRET

## Проверка работы:

```bash
# 1. Войдите на сайт
# 2. Откройте DevTools (F12)
# 3. Перейдите в Application > Local Storage
# 4. Проверьте наличие ключей:
#    - shakedown_user (данные пользователя)
#    - shakedown_token (JWT токен)
```

## Откат (если что-то пошло не так):

Если возникли проблемы, можно откатиться к старой версии:

```bash
# Восстановить старый сервер
cp server/index.backup.js server/index.js

# Закоммитить и задеплоить
git add server/index.js
git commit -m "Откат к версии с сессиями"
git push origin main
```

## Поддержка:

Если возникли вопросы или проблемы:
1. Проверьте логи на Render.com
2. Убедитесь, что JWT_SECRET добавлен в Environment Variables
3. Проверьте, что все зависимости установлены (jsonwebtoken)
