# Тестирование исправления аватарок

## Подготовка

1. Убедитесь, что база данных запущена и доступна
2. Убедитесь, что в `.env` файле настроены переменные:
   - `DATABASE_URL`
   - `GOOGLE_CLIENT_ID`
   - `GOOGLE_CLIENT_SECRET`
   - `GOOGLE_CALLBACK_URL`

## Запуск сервера

```bash
npm run server
```

Сервер должен запуститься и вывести:
- ✅ База данных инициализирована
- ✅ Администратор создан/обновлен
- ✅ Сервер запущен на порту 8080

## Запуск лаунчера

В отдельном терминале:

```bash
cd Launcher
npm run dev
```

## Сценарии тестирования

### Сценарий 1: Новый пользователь через Google OAuth

1. Откройте лаунчер
2. Нажмите "Войти через Google"
3. Авторизуйтесь в браузере
4. **Ожидаемый результат:**
   - Аватарка из Google профиля отображается в TitleBar, Sidebar и ProfilePage
   - В базе данных: `avatar` = `google_avatar` = URL из Google

### Сценарий 2: Загрузка пользовательской аватарки

1. Войдите в лаунчер (через Google или админ)
2. Откройте страницу "Профиль"
3. Нажмите на аватарку или кнопку "Изменить аватарку"
4. Выберите изображение (до 2MB)
5. **Ожидаемый результат:**
   - Аватарка загружается и отображается
   - Появляется кнопка "Восстановить Google аватарку"
   - Аватарка обновляется во всех компонентах (TitleBar, Sidebar, ProfilePage)
   - В базе данных: `avatar` = `custom_avatar` = base64 строка

### Сценарий 3: Повторный вход через Google с пользовательской аватаркой

1. Загрузите пользовательскую аватарку (Сценарий 2)
2. Выйдите из аккаунта
3. Войдите снова через Google OAuth
4. **Ожидаемый результат:**
   - Пользовательская аватарка сохраняется и отображается
   - Google аватарка НЕ перезаписывает пользовательскую
   - В базе данных: `avatar` = `custom_avatar`, `google_avatar` обновлен

### Сценарий 4: Восстановление Google аватарки

1. Загрузите пользовательскую аватарку (Сценарий 2)
2. Откройте страницу "Профиль"
3. Нажмите "Восстановить Google аватарку"
4. Подтвердите действие
5. **Ожидаемый результат:**
   - Google аватарка восстанавливается
   - Кнопка "Восстановить Google аватарку" исчезает
   - Аватарка обновляется во всех компонентах
   - В базе данных: `avatar` = `google_avatar`, `custom_avatar` = NULL

### Сценарий 5: Валидация файлов

1. Попробуйте загрузить:
   - Файл не-изображение (например, .txt)
   - Изображение больше 2MB
2. **Ожидаемый результат:**
   - Появляется сообщение об ошибке
   - Аватарка не загружается

### Сценарий 6: Админ без Google аватарки

1. Войдите через админ-панель (email + password)
2. Откройте страницу "Профиль"
3. Загрузите пользовательскую аватарку
4. **Ожидаемый результат:**
   - Аватарка загружается и отображается
   - Кнопка "Восстановить Google аватарку" НЕ появляется (т.к. нет google_avatar)
   - В базе данных: `avatar` = `custom_avatar`, `google_avatar` = NULL

## Проверка базы данных

Подключитесь к PostgreSQL и выполните:

```sql
SELECT id, username, email, 
       CASE WHEN avatar IS NOT NULL THEN 'есть' ELSE 'нет' END as avatar,
       CASE WHEN google_avatar IS NOT NULL THEN 'есть' ELSE 'нет' END as google_avatar,
       CASE WHEN custom_avatar IS NOT NULL THEN 'есть' ELSE 'нет' END as custom_avatar
FROM users;
```

## Проверка API endpoints

### Загрузка аватарки:
```bash
curl -X POST http://localhost:8080/api/users/1/avatar \
  -H "Content-Type: application/json" \
  -d '{"avatar": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="}'
```

### Удаление аватарки:
```bash
curl -X DELETE http://localhost:8080/api/users/1/avatar
```

### Получение информации о пользователе:
```bash
curl http://localhost:8080/api/users/1
```

## Возможные проблемы

### Аватарка не загружается
- Проверьте размер файла (макс. 2MB)
- Проверьте формат файла (должно быть изображение)
- Проверьте консоль браузера на ошибки
- Проверьте логи сервера

### Аватарка не обновляется в интерфейсе
- Проверьте, что `onUserUpdate` вызывается
- Проверьте localStorage (должен обновляться)
- Перезагрузите страницу

### Google аватарка перезаписывает пользовательскую
- Проверьте логику в `server/index.js` (строки 80-85)
- Убедитесь, что `custom_avatar` сохраняется в базе данных
- Проверьте логи сервера при OAuth входе

## Успешное тестирование

Все сценарии должны работать корректно:
- ✅ Загрузка пользовательской аватарки
- ✅ Восстановление Google аватарки
- ✅ Сохранение пользовательской аватарки при повторном входе через Google
- ✅ Валидация файлов
- ✅ Обновление аватарки во всех компонентах
- ✅ Корректное хранение в базе данных
